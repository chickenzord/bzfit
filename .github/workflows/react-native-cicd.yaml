name: Expo Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      buildType:
        type: choice
        description: "Build type to run"
        options:
          - prod-apk
          - prod-aab
          - publish-stores
          - all
        default: all
      build:
        type: number
        description: "Rebuild counter for this semver (0 = first build, increment on rebuild)"
        default: 0

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify versions are in sync
        run: node scripts/sync-version.js --check

  build-and-release:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ— Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: ðŸ“¦ Install dependencies
        run: |
          pnpm install
          pnpm add -g eas-cli@latest

      - name: ðŸ“± Setup EAS build cache
        uses: actions/cache@v3
        with:
          path: ~/.eas-build-local
          key: ${{ runner.os }}-eas-build-local-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-eas-build-local-

      - name: ðŸ”¢ Apply versionCode
        id: version
        run: |
          BUILD=${{ inputs.build || 0 }}
          node scripts/sync-version.js --build $BUILD
          VERSION=$(node -p "require('./packages/app/app.json').expo.version")
          VCODE=$(node -p "require('./packages/app/app.json').expo.android.versionCode")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VCODE" >> $GITHUB_OUTPUT
          # Tag format: vX.Y.Z for build 0, vX.Y.Z-bN for rebuilds
          if [ "$BUILD" = "0" ]; then
            TAG="v$VERSION"
          else
            TAG="v$VERSION-b$BUILD"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Write job summary for visibility
          echo "## ðŸ“¦ Build Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build counter | \`$BUILD\` |" >> $GITHUB_STEP_SUMMARY
          echo "| versionCode | \`$VCODE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release tag | \`$TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          NEXT_BUILD=$((BUILD + 1))
          echo "> If a rebuild is needed, rerun this workflow with **build = \`$NEXT_BUILD\`**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Setup signing secrets
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > packages/app/bzfit-release.jks
          cat > packages/app/credentials.json << EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "bzfit-release.jks",
                "keystorePassword": "$ANDROID_STORE_PASSWORD",
                "keyAlias": "$ANDROID_KEY_ALIAS",
                "keyPassword": "$ANDROID_KEY_PASSWORD"
              }
            }
          }
          EOF

      - name: ðŸ“± Build APK
        if: ${{ inputs.buildType == 'all' || inputs.buildType == 'prod-apk' || github.event_name == 'push' }}
        working-directory: packages/app
        env:
          NODE_ENV: production
          NODE_OPTIONS: "--max_old_space_size=4096"
        run: eas build --platform android --profile production-apk --local --non-interactive --output=${{ github.workspace }}/app-prod.apk

      - name: ðŸ“± Build AAB
        if: ${{ inputs.buildType == 'all' || inputs.buildType == 'prod-aab' || inputs.buildType == 'publish-stores' || github.event_name == 'push' }}
        working-directory: packages/app
        env:
          NODE_ENV: production
          NODE_OPTIONS: "--max_old_space_size=4096"
        run: eas build --platform android --profile production --local --non-interactive --output=${{ github.workspace }}/app-prod.aab

      - name: ðŸš€ Submit to Play Store
        if: ${{ inputs.buildType == 'all' || inputs.buildType == 'publish-stores' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: dev.akhy.bzfit
          releaseFiles: ${{ github.workspace }}/app-prod.aab
          track: internal

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          if git describe --tags --abbrev=0 > /dev/null 2>&1; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            git log "$LAST_TAG..HEAD" --pretty=format:"- %s" > changelog.md
          else
            git log --pretty=format:"- %s" -n 20 > changelog.md
          fi

      - name: ðŸš€ Create GitHub Release draft
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          tag_name: ${{ steps.version.outputs.tag }}
          name: "BzFit ${{ steps.version.outputs.tag }}"
          body_path: changelog.md
          files: |
            ./app-prod.apk
            ./app-prod.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-builds-${{ steps.version.outputs.tag }}
          path: |
            ./app-prod.apk
            ./app-prod.aab
          retention-days: 7
