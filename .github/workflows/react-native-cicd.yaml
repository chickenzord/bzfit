name: Expo Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      buildType:
        type: choice
        description: "Build type to run"
        options:
          - prod-apk
          - prod-aab
          - publish-stores
          - all
        default: all
      build:
        type: number
        description: "Rebuild counter for this semver (0 = first build, increment on rebuild)"
        default: 0

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

# Reusable signing setup
# Each build job decodes the keystore independently so they can run in parallel
# and be retried without depending on a shared setup job.

jobs:
  # â”€â”€â”€ Fast pre-flight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  check:
    name: Version check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Verify versions are in sync
        run: node scripts/sync-version.js --check

  version:
    name: Compute version
    needs: check
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.compute.outputs.version }}
      versionCode: ${{ steps.compute.outputs.versionCode }}
      build: ${{ steps.compute.outputs.build }}
      tag: ${{ steps.compute.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute version info
        id: compute
        run: |
          BUILD=${{ inputs.build || 0 }}
          VERSION=$(node -p "require('./package.json').version")
          VCODE=$(node -p "
            const [major, minor, patch] = '$VERSION'.split('.').map(Number);
            major * 1000000 + minor * 10000 + patch * 100 + $BUILD
          ")
          if [ "$BUILD" = "0" ]; then TAG="v$VERSION"; else TAG="v$VERSION-b$BUILD"; fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VCODE" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "## ðŸ“¦ Build Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build counter | \`$BUILD\` |" >> $GITHUB_STEP_SUMMARY
          echo "| versionCode | \`$VCODE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release tag | \`$TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          NEXT_BUILD=$((BUILD + 1))
          echo "> If a rebuild is needed, rerun this workflow with **build = \`$NEXT_BUILD\`**" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€ Builds (slow, run in parallel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  build-apk:
    name: Build APK
    needs: [check, version]
    if: github.event_name == 'push' || inputs.buildType == 'prod-apk' || inputs.buildType == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
      - name: Install dependencies
        run: |
          pnpm install
          pnpm add -g eas-cli@latest
      - uses: actions/cache@v3
        with:
          path: ~/.eas-build-local
          key: ${{ runner.os }}-eas-build-local-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-eas-build-local-
      - name: ðŸ” Setup signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > packages/app/bzfit-release.jks
          cat > packages/app/credentials.json << EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "bzfit-release.jks",
                "keystorePassword": "$ANDROID_STORE_PASSWORD",
                "keyAlias": "$ANDROID_KEY_ALIAS",
                "keyPassword": "$ANDROID_KEY_PASSWORD"
              }
            }
          }
          EOF
      - name: ðŸ“± Build APK
        working-directory: packages/app
        env:
          NODE_ENV: production
          NODE_OPTIONS: "--max_old_space_size=4096"
          APP_BUILD: ${{ needs.version.outputs.build }}
        run: eas build --platform android --profile production-apk --local --non-interactive --output=${{ github.workspace }}/app-prod.apk
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ needs.version.outputs.tag }}
          path: app-prod.apk
          retention-days: 7

  build-aab:
    name: Build AAB
    needs: [check, version]
    if: github.event_name == 'push' || inputs.buildType == 'prod-aab' || inputs.buildType == 'publish-stores' || inputs.buildType == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
      - name: Install dependencies
        run: |
          pnpm install
          pnpm add -g eas-cli@latest
      - uses: actions/cache@v3
        with:
          path: ~/.eas-build-local
          key: ${{ runner.os }}-eas-build-local-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-eas-build-local-
      - name: ðŸ” Setup signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > packages/app/bzfit-release.jks
          cat > packages/app/credentials.json << EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "bzfit-release.jks",
                "keystorePassword": "$ANDROID_STORE_PASSWORD",
                "keyAlias": "$ANDROID_KEY_ALIAS",
                "keyPassword": "$ANDROID_KEY_PASSWORD"
              }
            }
          }
          EOF
      - name: ðŸ“± Build AAB
        working-directory: packages/app
        env:
          NODE_ENV: production
          NODE_OPTIONS: "--max_old_space_size=4096"
          APP_BUILD: ${{ needs.version.outputs.build }}
        run: eas build --platform android --profile production --local --non-interactive --output=${{ github.workspace }}/app-prod.aab
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: aab-${{ needs.version.outputs.tag }}
          path: app-prod.aab
          retention-days: 7

  # â”€â”€â”€ Publishing (fast, independently retryable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  release:
    name: GitHub Release
    needs: [version, build-apk, build-aab]
    if: |
      always() &&
      needs.version.result == 'success' &&
      (needs.build-apk.result == 'success' || needs.build-aab.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download APK
        if: needs.build-apk.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: apk-${{ needs.version.outputs.tag }}
          path: artifacts/
      - name: Download AAB
        if: needs.build-aab.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: aab-${{ needs.version.outputs.tag }}
          path: artifacts/
      - name: Generate changelog
        run: |
          if git describe --tags --abbrev=0 > /dev/null 2>&1; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            git log "$LAST_TAG..HEAD" --pretty=format:"- %s" > changelog.md
          else
            git log --pretty=format:"- %s" -n 20 > changelog.md
          fi
      - name: ðŸš€ Create GitHub Release draft
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          tag_name: ${{ needs.version.outputs.tag }}
          name: "BzFit ${{ needs.version.outputs.tag }}"
          body_path: changelog.md
          files: artifacts/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-playstore:
    name: Publish to Play Store
    needs: [version, build-aab, release]
    if: |
      always() &&
      needs.build-aab.result == 'success' &&
      needs.release.result == 'success' &&
      (inputs.buildType == 'publish-stores' || inputs.buildType == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: aab-${{ needs.version.outputs.tag }}
          path: artifacts/
      - name: ðŸš€ Submit to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: dev.akhy.bzfit
          releaseFiles: artifacts/app-prod.aab
          track: internal
          status: draft
