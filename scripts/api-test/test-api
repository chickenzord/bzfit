#!/usr/bin/env bash
# BzFit API Testing Script
# Uses fixture users for authentication

set -e

BASE_URL="${BZFIT_API_URL:-http://localhost:3001}"
TOKEN_FILE="/tmp/bzfit-api-token"

# Default fixture user
DEFAULT_EMAIL="demo@bzfit.local"
DEFAULT_PASSWORD="Demo1234!"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Get or refresh JWT token
get_token() {
    local email="${1:-$DEFAULT_EMAIL}"
    local password="${2:-$DEFAULT_PASSWORD}"

    echo "Logging in as $email..." >&2

    local response=$(curl -s -X POST "$BASE_URL/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$email\",\"password\":\"$password\"}")

    local token=$(echo "$response" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

    if [ -z "$token" ]; then
        error "Login failed. Run 'npm run fixtures:load' to create fixture users."
    fi

    echo "$token" > "$TOKEN_FILE"
    success "Logged in as $email"
    echo "$token"
}

# Load token from file or login
load_token() {
    if [ -f "$TOKEN_FILE" ]; then
        cat "$TOKEN_FILE"
    else
        get_token
    fi
}

# Make authenticated curl request
api_curl() {
    local method="$1"
    local path="$2"
    local data="${3:-}"

    local token=$(load_token)
    local url="$BASE_URL$path"

    if [ -n "$data" ]; then
        curl -s -X "$method" "$url" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $token" \
            -d "$data"
    else
        curl -s -X "$method" "$url" \
            -H "Authorization: Bearer $token"
    fi
}

# Command handlers
cmd_login() {
    get_token "$@"
}

cmd_logout() {
    rm -f "$TOKEN_FILE"
    success "Logged out (token cleared)"
}

cmd_quick_add() {
    local name="$1"
    local variant="${2:-}"
    local brand="${3:-}"
    local size="$4"
    local unit="$5"
    local meal_type="$6"
    local date="${7:-$(date +%Y-%m-%d)}"
    local quantity="${8:-1.0}"

    if [ -z "$name" ] || [ -z "$size" ] || [ -z "$unit" ] || [ -z "$meal_type" ]; then
        error "Usage: bzfit-api quick-add NAME [VARIANT] [BRAND] SIZE UNIT MEAL_TYPE [DATE] [QUANTITY]"
    fi

    local food_json="{\"name\":\"$name\""
    [ -n "$variant" ] && food_json="$food_json,\"variant\":\"$variant\""
    [ -n "$brand" ] && food_json="$food_json,\"brand\":\"$brand\""
    food_json="$food_json}"

    local payload="{\"food\":$food_json,\"servingSize\":$size,\"servingUnit\":\"$unit\",\"mealType\":\"$meal_type\",\"date\":\"$date\",\"quantity\":$quantity}"

    api_curl POST "/api/v1/nutrition/meals/quick-add" "$payload"
}

cmd_search() {
    local query="$1"
    [ -z "$query" ] && error "Usage: bzfit-api search QUERY"

    api_curl GET "/api/v1/catalog/foods/search?q=$query"
}

cmd_daily_summary() {
    local date="${1:-$(date +%Y-%m-%d)}"
    api_curl GET "/api/v1/nutrition/meals/daily-summary?date=$date"
}

cmd_list_meals() {
    local date="$1"
    local url="/api/v1/nutrition/meals"
    [ -n "$date" ] && url="$url?date=$date"

    api_curl GET "$url"
}

cmd_create_meal() {
    local meal_type="$1"
    local date="${2:-$(date +%Y-%m-%d)}"

    [ -z "$meal_type" ] && error "Usage: bzfit-api create-meal MEAL_TYPE [DATE]"

    local payload="{\"mealType\":\"$meal_type\",\"date\":\"$date\"}"
    api_curl POST "/api/v1/nutrition/meals" "$payload"
}

cmd_curl() {
    api_curl "$@"
}

cmd_help() {
    cat << EOF
BzFit API Test Tool

Usage: bzfit-api COMMAND [ARGS...]

Commands:
  login [EMAIL] [PASSWORD]          Get JWT token (default: demo@bzfit.local)
  logout                            Clear stored token

  quick-add NAME [VAR] [BRAND] SIZE UNIT MEAL_TYPE [DATE] [QTY]
                                    Quick-add food to meal

  search QUERY                      Search foods
  daily-summary [DATE]              Get daily meal summary
  list-meals [DATE]                 List meals
  create-meal MEAL_TYPE [DATE]      Create new meal

  curl METHOD PATH [DATA]           Raw authenticated API request

  help                              Show this help

Examples:
  bzfit-api login
  bzfit-api quick-add "Nasi Goreng" "Seafood" "Warung" 250 g LUNCH
  bzfit-api search "rice"
  bzfit-api daily-summary 2026-02-14
  bzfit-api curl GET /api/v1/catalog/foods

Fixture Users:
  demo@bzfit.local  / Demo1234!
  admin@bzfit.local / Admin1234!
  user@example.com  / securePassword123

Note: If login fails, run 'npm run fixtures:load' first.

Environment:
  BZFIT_API_URL  API base URL (default: http://localhost:3001)
EOF
}

# Main command router
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        login)          cmd_login "$@" ;;
        logout)         cmd_logout "$@" ;;
        quick-add)      cmd_quick_add "$@" ;;
        search)         cmd_search "$@" ;;
        daily-summary)  cmd_daily_summary "$@" ;;
        list-meals)     cmd_list_meals "$@" ;;
        create-meal)    cmd_create_meal "$@" ;;
        curl)           cmd_curl "$@" ;;
        help|--help|-h) cmd_help ;;
        *)              error "Unknown command: $cmd (try 'bzfit-api help')" ;;
    esac
}

main "$@"
